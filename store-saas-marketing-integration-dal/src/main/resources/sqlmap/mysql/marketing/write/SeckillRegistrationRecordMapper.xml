<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tuhu.store.saas.marketing.mysql.marketing.write.dao.SeckillRegistrationRecordMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.tuhu.store.saas.marketing.dataobject.SeckillRegistrationRecord">
        <id column="id" property="id" />
        <result column="order_no" property="orderNo" />
        <result column="store_id" property="storeId" />
        <result column="tenant_id" property="tenantId" />
        <result column="seckill_activity_id" property="seckillActivityId" />
        <result column="seckill_activity_name" property="seckillActivityName" />
        <result column="customer_id" property="customerId" />
        <result column="customer_name" property="customerName" />
        <result column="is_new_customer" property="isNewCustomer" />
        <result column="buyer_phone_number" property="buyerPhoneNumber" />
        <result column="user_phone_number" property="userPhoneNumber" />
        <result column="vehicle_number" property="vehicleNumber" />
        <result column="unit_price" property="unitPrice" />
        <result column="quantity" property="quantity" />
        <result column="expect_amount" property="expectAmount" />
        <result column="register_time" property="registerTime" />
        <result column="effective_time" property="effectiveTime" />
        <result column="payment_time" property="paymentTime" />
        <result column="usage_status" property="usageStatus" />
        <result column="pay_status" property="payStatus" />
        <result column="payment_mode_code" property="paymentModeCode" />
        <result column="create_user" property="createUser" />
        <result column="update_user" property="updateUser" />
        <result column="create_time" property="createTime" />
        <result column="update_time" property="updateTime" />
        <result column="is_delete" property="isDelete" />
    </resultMap>

    <select id="pageBuyList" resultMap="BaseResultMap">
        SELECT
        store_id,tenant_id,seckill_activity_id,customer_id,customer_name,buyer_phone_number,
        count(1) as quantity,sum(expect_amount) as expect_amount,max(is_new_customer) as is_new_customer
        FROM seckill_registration_record
        WHERE
        1=1
        AND is_delete = 0
        AND pay_status = 1
        AND store_id = #{storeId}
        AND tenant_id = #{tenantId}
        AND seckill_activity_id = #{seckillActivityId}
        <if test="phone != null and phone != ''">
            and buyer_phone_number like CONCAT('%',#{phone},'%')
        </if>
        group by store_id,tenant_id,seckill_activity_id,customer_id,customer_name,buyer_phone_number
        order by payment_time desc
    </select>

    <select id="dataStatistics" resultMap="BaseResultMap">
        SELECT
        store_id,tenant_id,seckill_activity_id,
        SUM(quantity) AS quantity,
        SUM(expect_amount) AS expect_amount
        FROM seckill_registration_record
        WHERE
        1=1
        AND is_delete = 0
        AND pay_status = 1
        AND store_id = #{storeId}
        AND tenant_id = #{tenantId}
        <if test="type != null and type == 0 ">
            AND date_format(payment_time, '%Y-%m-%d') = date_format(now(), '%Y-%m-%d')
        </if>
        AND seckill_activity_id = #{seckillActivityId}
        GROUP BY store_id,tenant_id,seckill_activity_id
    </select>
    
    <select id="getAllUserCountByTypeAndSeckillActivityId" resultType="java.lang.String">
        SELECT DISTINCT customer_id FROM
        client_event_record
        WHERE 1=1
        AND phone_number != '0'
        AND customer_id IS NOT NULL
        AND content_value = #{seckillActivityId}
        <if test="type != null and type == 0 ">
            AND content_type = 'registered'
        </if>
        <if test="type != null and type == 1 ">
            AND content_type != 'registered'
        </if>
    </select>


    <select id="getBuyCountByTypeAndSeckillActivityId" resultType="java.lang.String">
        SELECT DISTINCT a.customer_id
        FROM seckill_registration_record a
        WHERE
        1=1
        AND a.is_delete = 0
        AND a.pay_status = 1
        AND a.seckill_activity_id = #{seckillActivityId}
        AND EXISTS (
            SELECT b.customer_id FROM client_event_record b
            WHERE 1=1
            AND a.seckill_activity_id = b.content_value
            AND a.customer_id = b.customer_id
            AND phone_number != '0'
            AND customer_id IS NOT NULL
            <if test="type != null and type == 0 ">
                AND b.content_type = 'registered'
            </if>
            <if test="type != null and type == 1 ">
                AND b.content_type != 'registered'
            </if>
        )
    </select>

    <select id="pageNoBuyBrowseList" resultMap="BaseResultMap">
        SELECT MIN(create_time) as create_time, customer_id, phone_number as buyer_phone_number
        FROM client_event_record a
        WHERE
        1=1
        AND phone_number != '0'
        AND customer_id IS NOT NULL
        AND content_value = #{seckillActivityId}
        AND NOT EXISTS (
            SELECT b.customer_id
            FROM seckill_registration_record b
            WHERE
            1=1
            AND a.content_value = b.seckill_activity_id
            AND a.customer_id = b.customer_id
            AND b.pay_status = 1
        )
        <if test="phone != null and phone != ''">
            AND phone_number like CONCAT('%',#{phone},'%')
        </if>
        GROUP BY customer_id,phone_number
        ORDER BY create_time DESC
    </select>

    <select id="seckillActivity24AutoCancel" resultMap="BaseResultMap">
      SELECT
      id,store_id,tenant_id,seckill_activity_id,order_no
      FROM seckill_registration_record
      WHERE 1=1
      AND pay_status = 0 <!--未支付-->
      AND DATE_ADD(register_time, INTERVAL 24 HOUR) <![CDATA[<=]]> NOW()  limit #{num}
    </select>
</mapper>
